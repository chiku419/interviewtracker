<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placement Report | 2024-26</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
        }

        .metric-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col bg-slate-50">

    <!-- Header -->
    <header class="glass-effect border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-5">
                <img src="logo.jpeg" alt="Institute Logo" class="h-12 w-auto object-contain drop-shadow-sm">
                <div class="h-8 w-px bg-slate-200"></div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Placement Report</h1>
                    <p class="text-xs text-indigo-600 font-semibold uppercase tracking-wider">Batch 2024-26</p>
                </div>
            </div>
            <div class="text-right hidden sm:block">
                <p class="text-sm font-medium text-slate-500">Final Placement Statistics</p>
                <p class="text-xs text-slate-400" id="lastUpdated">Updating...</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">

        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-32">
            <div class="relative">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600"></div>
                <div class="absolute top-0 left-0 h-16 w-16 rounded-full border-t-2 border-indigo-200 animate-pulse">
                </div>
            </div>
            <p class="text-slate-500 font-medium mt-6 animate-pulse">Fetching placement insights...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden space-y-6">

            <!-- Hero Metrics -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                        <span class="p-2 bg-indigo-100 rounded-lg text-indigo-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                        </span>
                        Key Highlights
                    </h2>
                    <button onclick="openStudentModal('All')"
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        All Details
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <!-- Average CTC -->
                    <div
                        class="metric-card bg-white rounded-2xl p-5 border border-slate-100 shadow-sm relative overflow-hidden group">
                        <div
                            class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-50 rounded-full group-hover:scale-150 transition-transform duration-500">
                        </div>
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 relative z-10">
                            Average CTC</p>
                        <div class="flex items-baseline gap-1 relative z-10">
                            <span class="text-2xl font-bold text-slate-900" id="avgCtc">--</span>
                            <span class="text-xs font-semibold text-slate-400">LPA</span>
                        </div>
                        <div
                            class="mt-3 flex items-center text-[10px] font-bold text-indigo-700 bg-indigo-50 w-fit px-2 py-1 rounded-full relative z-10">
                            Batch Average
                        </div>
                    </div>

                    <!-- Median CTC -->
                    <div
                        class="metric-card bg-white rounded-2xl p-5 border border-slate-100 shadow-sm relative overflow-hidden group">
                        <div
                            class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full group-hover:scale-150 transition-transform duration-500">
                        </div>
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 relative z-10">
                            Median CTC</p>
                        <div class="flex items-baseline gap-1 relative z-10">
                            <span class="text-2xl font-bold text-slate-900" id="medianCtc">--</span>
                            <span class="text-xs font-semibold text-slate-400">LPA</span>
                        </div>
                        <div
                            class="mt-3 flex items-center text-[10px] font-bold text-blue-700 bg-blue-50 w-fit px-2 py-1 rounded-full relative z-10">
                            Middle Value
                        </div>
                    </div>

                    <!-- Top 10% -->
                    <div
                        class="metric-card bg-white rounded-2xl p-5 border border-slate-100 shadow-sm relative overflow-hidden group">
                        <div
                            class="absolute -right-6 -top-6 w-24 h-24 bg-amber-50 rounded-full group-hover:scale-150 transition-transform duration-500">
                        </div>
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 relative z-10">Top
                            10% Avg</p>
                        <div class="flex items-baseline gap-1 relative z-10">
                            <span class="text-2xl font-bold text-slate-900" id="top10Ctc">--</span>
                            <span class="text-xs font-semibold text-slate-400">LPA</span>
                        </div>
                        <div
                            class="mt-3 flex items-center text-[10px] font-bold text-amber-700 bg-amber-50 w-fit px-2 py-1 rounded-full relative z-10">
                            Cream of the Crop
                        </div>
                    </div>

                    <!-- Top 25% -->
                    <div
                        class="metric-card bg-white rounded-2xl p-5 border border-slate-100 shadow-sm relative overflow-hidden group">
                        <div
                            class="absolute -right-6 -top-6 w-24 h-24 bg-purple-50 rounded-full group-hover:scale-150 transition-transform duration-500">
                        </div>
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 relative z-10">Top
                            25% Avg</p>
                        <div class="flex items-baseline gap-1 relative z-10">
                            <span class="text-2xl font-bold text-slate-900" id="top25Ctc">--</span>
                            <span class="text-xs font-semibold text-slate-400">LPA</span>
                        </div>
                        <div
                            class="mt-3 flex items-center text-[10px] font-bold text-purple-700 bg-purple-50 w-fit px-2 py-1 rounded-full relative z-10">
                            Top Quartile
                        </div>
                    </div>

                    <!-- Expected vs Actual Card -->
                    <div onclick="openModal()"
                        class="metric-card bg-white rounded-2xl p-5 border border-slate-100 shadow-sm relative overflow-hidden group cursor-pointer ring-2 ring-transparent hover:ring-rose-100">
                        <div
                            class="absolute -right-6 -top-6 w-24 h-24 bg-rose-50 rounded-full group-hover:scale-150 transition-transform duration-500">
                        </div>
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Performance
                                </p>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-2xl font-bold text-slate-900" id="actualTotal">--</span>
                                    <span class="text-xs font-medium text-slate-400">/ <span
                                            id="expectedTotal">--</span></span>
                                </div>
                                <p class="text-[10px] font-medium text-rose-500 mt-1">Actual vs Expected</p>
                            </div>
                            <!-- Mini Chart Container -->
                            <div class="h-10 w-16">
                                <canvas id="miniChart"></canvas>
                            </div>
                        </div>
                        <div
                            class="mt-3 flex items-center text-[10px] font-bold text-rose-700 bg-rose-50 w-fit px-2 py-1 rounded-full relative z-10 group-hover:bg-rose-100 transition-colors">
                            View Details →
                        </div>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-5">

                <!-- Demographics Chart -->
                <div
                    class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="p-1.5 bg-indigo-100 rounded-lg text-indigo-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                        </span>
                        Placement Demographics
                    </h3>
                    <div class="relative h-56 w-full flex items-center justify-center">
                        <canvas id="demographicsChart"></canvas>
                    </div>
                    <div id="demographicsLegend" class="mt-4">
                        <!-- Dynamic Legend -->
                    </div>
                </div>

                <!-- Work Experience Chart -->
                <div
                    class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="p-1.5 bg-emerald-100 rounded-lg text-emerald-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                </path>
                            </svg>
                        </span>
                        Work Experience Profile
                    </h3>
                    <div class="relative h-56 w-full flex items-center justify-center">
                        <canvas id="workExChart"></canvas>
                    </div>
                    <div id="workExLegend" class="mt-4">
                        <!-- Dynamic Legend -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal -->
    <div id="chartModal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl mx-4 p-6 transform scale-95 transition-transform duration-300"
            id="modalContent">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Company-wise Performance</h3>
                    <p class="text-sm text-slate-500">Expected vs Actual Placements</p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="h-[500px] w-full">
                <canvas id="detailedChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentModal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 flex flex-col max-h-[80vh] transform scale-95 transition-transform duration-300"
            id="studentModalContent">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl z-10">
                <div>
                    <h3 class="text-xl font-bold text-slate-800" id="studentModalTitle">Student Details</h3>
                    <p class="text-sm text-slate-500" id="studentModalSubtitle">List of placed students</p>
                </div>
                <button onclick="closeStudentModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="overflow-auto flex-grow p-0">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Name
                            </th>
                            <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Company
                            </th>
                            <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Degree
                            </th>
                            <th
                                class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider text-right">
                                CTC (LPA)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="studentTableBody">
                        <!-- Rows will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl text-right">
                <p class="text-xs text-slate-400 font-medium" id="studentCount">Total: 0</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-400 text-sm font-medium">© 2024 Placement Cell. All rights reserved.</p>
        </div>
    </footer>

    <script>
        let detailedChartInstance = null;
        let miniChartInstance = null;
        let demographicsChartInstance = null;
        let workExChartInstance = null;
        let placementData = null;

        async function fetchReportData() {
            try {
                const response = await fetch('/api/placement-report');
                const data = await response.json();

                if (data.success) {
                    placementData = data;
                    renderDashboard(data.metrics, data.expected);
                } else {
                    console.error('Failed to fetch data:', data.error);
                    alert('Failed to load placement data. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function formatCurrency(value) {
            return value.toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }

        function renderDashboard(metrics, expectedData) {
            // Hide loading, show dashboard
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Update Text Metrics
            document.getElementById('avgCtc').textContent = formatCurrency(metrics.averageCTC);
            document.getElementById('medianCtc').textContent = formatCurrency(metrics.medianCTC);
            document.getElementById('top10Ctc').textContent = formatCurrency(metrics.top10Avg);
            document.getElementById('top25Ctc').textContent = formatCurrency(metrics.top25Avg);



            // Process Expected Data
            const companies = expectedData.map(row => row.Company).filter(c => c);
            const expectedCounts = expectedData.map(row => parseInt(row['Expected Count'] || 0));
            const actualCounts = expectedData.map(row => parseInt(row['Actual'] || 0));

            const totalExpected = expectedCounts.reduce((a, b) => a + b, 0);
            const totalActual = actualCounts.reduce((a, b) => a + b, 0);

            document.getElementById('expectedTotal').textContent = totalExpected;
            document.getElementById('actualTotal').textContent = totalActual;

            // Render Mini Chart
            const miniCtx = document.getElementById('miniChart').getContext('2d');
            miniChartInstance = new Chart(miniCtx, {
                type: 'line',
                data: {
                    labels: companies,
                    datasets: [{
                        data: actualCounts,
                        borderColor: '#f43f5e', // Rose 500
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });

            // Center Text Plugin
            const centerTextPlugin = {
                id: 'centerText',
                beforeDraw: function (chart) {
                    if (chart.config.type !== 'doughnut') return;

                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;

                    ctx.restore();

                    // Total Count
                    const total = chart.config.data.datasets[0].data.reduce((a, b) => a + b, 0);

                    const fontSize = (height / 114).toFixed(2);
                    ctx.font = `bold ${fontSize}em Outfit`;
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#1e293b'; // Slate 800

                    const text = total.toString();
                    const textX = Math.round((width - ctx.measureText(text).width) / 2);
                    const textY = height / 2;

                    ctx.fillText(text, textX, textY);

                    // Label
                    const labelFontSize = (height / 250).toFixed(2);
                    ctx.font = `500 ${labelFontSize}em Outfit`;
                    ctx.fillStyle = '#64748b'; // Slate 500

                    const label = "Students";
                    const labelX = Math.round((width - ctx.measureText(label).width) / 2);
                    const labelY = height / 2 + 25;

                    ctx.fillText(label, labelX, labelY);

                    ctx.save();
                }
            };

            // Register Plugin
            Chart.register(centerTextPlugin);

            // Update Demographics Chart
            const ctx = document.getElementById('demographicsChart').getContext('2d');
            demographicsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Engineers (B.Tech)', 'Non-Engineers'],
                    datasets: [{
                        data: [metrics.demographics.engineers, metrics.demographics.nonEngineers],
                        backgroundColor: [
                            '#6366f1', // Indigo 500
                            '#fb7185'  // Rose 400
                        ],
                        borderWidth: 0,
                        hoverOffset: 4,
                        borderRadius: 20,
                        spacing: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const label = demographicsChartInstance.data.labels[index];
                            openStudentModal(label);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false // Disable default tooltip for cleaner look
                        }
                    }
                }
            });

            // Update Demographics Legend
            const demoTotal = metrics.demographics.total;
            const demoLegendHTML = `
                <div class="flex justify-center gap-6">
                    <div class="flex flex-col items-center cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-colors" onclick="openStudentModal('Engineers (B.Tech)')">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-3 h-3 rounded-full bg-indigo-500 shadow-sm"></span>
                            <span class="text-sm font-medium text-slate-500">Engineers</span>
                        </div>
                        <div class="text-lg font-bold text-slate-800">
                            ${metrics.demographics.engineers} <span class="text-xs font-medium text-slate-400">(${Math.round(metrics.demographics.engineers / demoTotal * 100)}%)</span>
                        </div>
                    </div>
                    <div class="w-px bg-slate-100 h-12"></div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-colors" onclick="openStudentModal('Non-Engineers')">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-3 h-3 rounded-full bg-rose-400 shadow-sm"></span>
                            <span class="text-sm font-medium text-slate-500">Non-Engineers</span>
                        </div>
                        <div class="text-lg font-bold text-slate-800">
                            ${metrics.demographics.nonEngineers} <span class="text-xs font-medium text-slate-400">(${Math.round(metrics.demographics.nonEngineers / demoTotal * 100)}%)</span>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('demographicsLegend').innerHTML = demoLegendHTML;

            // Update Work Experience Chart
            const workCtx = document.getElementById('workExChart').getContext('2d');
            workExChartInstance = new Chart(workCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Freshers', 'Experienced'],
                    datasets: [{
                        data: [metrics.workEx.freshers, metrics.workEx.experienced],
                        backgroundColor: [
                            '#10b981', // Emerald 500
                            '#f59e0b'  // Amber 500
                        ],
                        borderWidth: 0,
                        hoverOffset: 4,
                        borderRadius: 20,
                        spacing: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const label = workExChartInstance.data.labels[index];
                            openStudentModal(label);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });

            // Update Work Ex Legend
            const workTotal = metrics.workEx.freshers + metrics.workEx.experienced;
            const workLegendHTML = `
                <div class="flex justify-center gap-6">
                    <div class="flex flex-col items-center cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-colors" onclick="openStudentModal('Freshers')">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-3 h-3 rounded-full bg-emerald-500 shadow-sm"></span>
                            <span class="text-sm font-medium text-slate-500">Freshers</span>
                        </div>
                        <div class="text-lg font-bold text-slate-800">
                            ${metrics.workEx.freshers} <span class="text-xs font-medium text-slate-400">(${Math.round(metrics.workEx.freshers / workTotal * 100)}%)</span>
                        </div>
                    </div>
                    <div class="w-px bg-slate-100 h-12"></div>
                    <div class="flex flex-col items-center cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-colors" onclick="openStudentModal('Experienced')">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-3 h-3 rounded-full bg-amber-500 shadow-sm"></span>
                            <span class="text-sm font-medium text-slate-500">Experienced</span>
                        </div>
                        <div class="text-lg font-bold text-slate-800">
                            ${metrics.workEx.experienced} <span class="text-xs font-medium text-slate-400">(${Math.round(metrics.workEx.experienced / workTotal * 100)}%)</span>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('workExLegend').innerHTML = workLegendHTML;

            // Update timestamp
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        }

        // Student Modal Functions
        function openStudentModal(category) {
            const modal = document.getElementById('studentModal');
            const content = document.getElementById('studentModalContent');
            const title = document.getElementById('studentModalTitle');
            const subtitle = document.getElementById('studentModalSubtitle');
            const tbody = document.getElementById('studentTableBody');
            const countLabel = document.getElementById('studentCount');

            // Filter Data
            let filteredStudents = [];
            if (category === 'All') {
                filteredStudents = placementData.students;
                title.textContent = 'All Placed Students';
            } else if (category.includes('Engineers (B.Tech)')) {
                filteredStudents = placementData.students.filter(s => s.degree === 'B.Tech');
                title.textContent = 'Engineers (B.Tech)';
            } else if (category.includes('Non-Engineers')) {
                filteredStudents = placementData.students.filter(s => s.degree !== 'B.Tech');
                title.textContent = 'Non-Engineers';
            } else if (category === 'Freshers') {
                filteredStudents = placementData.students.filter(s => !s.workEx || s.workEx == 0);
                title.textContent = 'Freshers';
            } else if (category === 'Experienced') {
                filteredStudents = placementData.students.filter(s => s.workEx > 0);
                title.textContent = 'Experienced Professionals';
            }

            subtitle.textContent = `Showing ${filteredStudents.length} placed students`;
            countLabel.textContent = `Total: ${filteredStudents.length}`;

            // Populate Table
            tbody.innerHTML = filteredStudents.map(student => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${student.company}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${student.degree}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-800 text-right">${formatCurrency(student.ctc)}</td>
                </tr>
            `).join('');

            // Show Modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeStudentModal() {
            const modal = document.getElementById('studentModal');
            const content = document.getElementById('studentModalContent');

            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }

        // Close on click outside
        document.getElementById('studentModal').addEventListener('click', (e) => {
            if (e.target.id === 'studentModal') closeStudentModal();
        });

        // Modal Functions
        function openModal() {
            const modal = document.getElementById('chartModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Animation
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);

            // Render Detailed Chart if not exists
            if (!detailedChartInstance && placementData) {
                const ctx = document.getElementById('detailedChart').getContext('2d');
                const companies = placementData.expected.map(row => row.Company).filter(c => c);
                const expectedCounts = placementData.expected.map(row => parseInt(row['Expected Count'] || 0));
                const actualCounts = placementData.expected.map(row => parseInt(row['Actual'] || 0));
                // Detailed Chart
                const detailedCtx = document.getElementById('detailedChart').getContext('2d');

                // Create Gradient
                const gradient = detailedCtx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(79, 70, 229, 0.2)'); // Indigo 600 low opacity
                gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');   // Transparent

                detailedChartInstance = new Chart(detailedCtx, {
                    type: 'line',
                    data: {
                        labels: companies,
                        datasets: [
                            {
                                label: 'Expected',
                                data: expectedCounts,
                                borderColor: '#cbd5e1', // Slate 300
                                borderWidth: 2,
                                borderDash: [4, 4],
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#cbd5e1',
                                pointBorderWidth: 2,
                                tension: 0.1, // Slight curve, precise
                                fill: false
                            },
                            {
                                label: 'Actual',
                                data: actualCounts,
                                borderColor: '#4f46e5', // Indigo 600
                                borderWidth: 2,
                                backgroundColor: gradient,
                                pointRadius: 3,
                                pointHoverRadius: 5,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#4f46e5',
                                pointBorderWidth: 2,
                                tension: 0.2, // Smooth but not wavy
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'end',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 8,
                                    font: {
                                        family: 'Outfit',
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleFont: { family: 'Outfit', size: 13 },
                                bodyFont: { family: 'Outfit', size: 13 },
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#f1f5f9', // Very subtle grid
                                    drawBorder: false
                                },
                                ticks: {
                                    font: { family: 'Outfit', size: 11 },
                                    color: '#64748b',
                                    padding: 10,
                                    stepSize: 1
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { family: 'Outfit', size: 11 },
                                    color: '#64748b',
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }
        }

        function closeModal() {
            const modal = document.getElementById('chartModal');
            const content = document.getElementById('modalContent');

            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }

        // Close on click outside
        document.getElementById('chartModal').addEventListener('click', (e) => {
            if (e.target.id === 'chartModal') closeModal();
        });

        // Initialize
        fetchReportData();
    </script>
</body>

</html>